# 運営者編集画面設計書

- 画面名: `運営者編集`
- パス: `/operation/admins/[id]`
- URL: https://carebase-admin.vercel.app/operation/admins/[id]

## 概要

運営者向け運営者編集画面設計書です。
既存の運営者情報を編集・更新する機能を提供し、基本情報と連絡先情報の変更を行えます。

主要機能は以下の通りです：

1. 既存運営者データの取得と表示
2. 運営者情報の編集（氏名、フリガナ、部署、連絡先等）
3. リアルタイムバリデーション機能
4. 入力データの検証とエラー表示
5. 更新処理とフィードバック表示
6. 運営者一覧画面への遷移

## 全体レイアウト

### 画面構成

運営者編集画面は、ページヘッダー、フォームセクション、アクションボタンで構成されます。
既存データを事前に入力した状態で表示し、効率的な情報更新を支援します。

### 画面項目

| 項目名           | コンポーネント | 必須 | 最小桁数 | 最大桁数 | フォーマット | 初期値                          | 備考                         |
| ---------------- | -------------- | ---- | -------- | -------- | ------------ | ------------------------------- | ---------------------------- |
| 戻るボタン       | Button + Link  | -    | -        | -        | -            | -                               | 運営者一覧画面への戻るボタン |
| ページタイトル   | h1             | -    | -        | -        | -            | 運営管理者の編集                | ページメインタイトル         |
| ページ説明       | p              | -    | -        | -        | -            | 運営管理者の情報を編集します    | 固定説明文                   |
| 管理者フォーム   | AdminForm      | -    | -        | -        | -            | -                               | 運営者情報編集フォーム       |
| ローディング表示 | LoadingSpinner | -    | -        | -        | -            | "読み込み中..."                 | データ取得中の表示           |
| エラー表示       | ErrorState     | -    | -        | -        | -            | "エラーが発生しました: {error}" | データ取得エラー時の表示     |

## データ取得・表示仕様

### 初期データ読み込み

- **運営者データ取得**: ページ読み込み時に運営者IDから既存データを取得
- **フォーム初期化**: 取得したデータでフォームフィールドを初期化
- **ローディング表示**: データ取得中はローディングスピナーを表示
- **エラーハンドリング**: データ取得失敗時の適切なエラー表示

### 初期値設定

| 項目名         | 初期値設定                      |
| -------------- | ------------------------------- |
| 氏名           | `admin.name`                    |
| フリガナ       | `admin.nameKana`                |
| メールアドレス | `admin.email`                   |
| 電話番号       | `admin.phoneNumber`             |
| 部署           | `admin.department` または空文字 |

## フォーム構造

### 基本情報セクション

| 項目名   | コンポーネント | 必須 | 最小桁数 | 最大桁数 | フォーマット | プレースホルダー | バリデーション                                 |
| -------- | -------------- | ---- | -------- | -------- | ------------ | ---------------- | ---------------------------------------------- |
| 氏名     | Input          | ◯    | 1        | 50       | text         | 山田太郎         | 必須チェック、文字数チェック                   |
| フリガナ | Input          | ◯    | 1        | 50       | text         | ヤマダタロウ     | 必須チェック、カタカナチェック、文字数チェック |
| 部署     | Input          | -    | -        | 50       | text         | 総務部           | 文字数チェック（任意）                         |

### 連絡先情報セクション

| 項目名         | コンポーネント | 必須 | 最小桁数 | 最大桁数 | フォーマット | プレースホルダー  | バリデーション                             |
| -------------- | -------------- | ---- | -------- | -------- | ------------ | ----------------- | ------------------------------------------ |
| メールアドレス | Input          | ◯    | 1        | -        | email        | admin@example.com | 必須チェック、メールフォーマットチェック   |
| 電話番号       | Input          | ◯    | 1        | -        | text         | 03-1234-5678      | 必須チェック、電話番号フォーマットチェック |

## 機能仕様

### アクション

| 項目名     | 処理内容             | 対象API                   | 遷移先画面                           |
| ---------- | -------------------- | ------------------------- | ------------------------------------ |
| 戻るボタン | 運営者一覧画面へ戻る | -                         | 運営者一覧画面 (`/operation/admins`) |
| キャンセル | 運営者一覧画面へ戻る | -                         | 運営者一覧画面 (`/operation/admins`) |
| 更新ボタン | 運営者更新処理を実行 | `PUT /api/v1/admins/[id]` | 運営者一覧画面 (`/operation/admins`) |

### データフロー

#### 初期化フロー

1. **ページアクセス**: URLパラメータから運営者IDを取得
2. **データ取得**: useAdminフックで運営者データを取得
3. **ローディング表示**: データ取得中はスピナー表示
4. **フォーム初期化**: 取得データでフォームを初期化
5. **編集可能状態**: フォーム表示完了

#### 更新フロー

1. **バリデーション**: フォーム送信時にクライアント側バリデーション実行
2. **API呼び出し**: updateAdmin関数で更新APIを呼び出し
3. **楽観的更新**: 成功時にローカル状態を即座に更新
4. **成功通知**: トースト通知で更新成功をフィードバック
5. **画面遷移**: 運営者一覧画面に自動遷移

### 状態管理

#### データ取得状態

- **admin**: 取得した運営者データ（Admin型 | null）
- **loading**: データ取得中の状態（boolean）
- **error**: エラーメッセージ（string | null）

#### フォーム状態

- **AdminForm**: 既存データを初期値として設定
- **バリデーション**: 編集用バリデーションスキーマの適用
- **エラーハンドリング**: フィールド別のエラー表示

#### 処理状態

- **loading**: 更新処理中のローディング状態
- **ボタン無効化**: 処理中は全ボタンを無効化
- **エラーハンドリング**: 更新失敗時のエラー表示

### バリデーション仕様

#### 編集モード専用バリデーション

- **adminEditSchema**: 編集用のZodスキーマを使用
- **必須項目維持**: 登録時と同様の必須項目チェック
- **データ整合性**: 既存データとの整合性チェック
- **重複チェック**: メールアドレスの重複確認（自身を除く）

## コンポーネント構成

### 主要コンポーネント

- **AdminEditPage** (`app/(dashboard)/operation/admins/[id]/page.tsx`)
  - ページ全体の制御とレイアウト
  - 運営者データの取得と状態管理
  - フォーム送信処理とエラーハンドリング
  - 成功時の画面遷移制御

- **AdminForm** (`components/2_molecules/forms/admin-form.tsx`)
  - 運営者フォーム全体の制御とレイアウト
  - admin prop で既存データを初期値として設定
  - adminEditSchema による編集用バリデーション

### 状態管理フック

- **useAdmin** (`hooks/use-admins.ts`)
  - 個別運営者データの取得と管理
  - ローディング・エラー状態の管理
  - データ再取得機能

- **useAdmins** (`hooks/use-admins.ts`)
  - updateAdmin関数による運営者更新処理
  - 楽観的更新による UI 応答性向上
  - エラーハンドリングと状態管理

### ローディング・エラー状態

#### IDチェック

```typescript
if (!id) {
  return (
    <div className="space-y-6">
      <div className="flex items-center space-x-4">
        <Button variant="outline" size="sm" asChild>
          <Link href="/operation/admins">
            <ArrowLeft className="mr-2 h-4 w-4" />
            戻る
          </Link>
        </Button>
        <div>
          <h1 className="text-2xl font-bold tracking-tight">運営管理者の編集</h1>
          <p className="text-muted-foreground">運営管理者の情報を編集します</p>
        </div>
      </div>

      <div className="rounded-md bg-red-50 p-4">
        <div className="text-sm text-red-700">管理者IDが指定されていません。</div>
      </div>
    </div>
  );
}
```

#### エラー状態

```typescript
if (error) {
  return (
    <div className="space-y-6">
      <div className="flex items-center space-x-4">
        <Button variant="outline" size="sm" asChild>
          <Link href="/operation/admins">
            <ArrowLeft className="mr-2 h-4 w-4" />
            戻る
          </Link>
        </Button>
        <div>
          <h1 className="text-2xl font-bold tracking-tight">運営管理者の編集</h1>
          <p className="text-muted-foreground">運営管理者の情報を編集します</p>
        </div>
      </div>

      <div className="rounded-md bg-red-50 p-4">
        <div className="text-sm text-red-700">エラーが発生しました: {error}</div>
      </div>
    </div>
  );
}
```

#### ローディング状態

```typescript
if (loading) {
  return (
    <div className="space-y-6">
      <div className="flex items-center space-x-4">
        <Button variant="outline" size="sm" asChild>
          <Link href="/operation/admins">
            <ArrowLeft className="mr-2 h-4 w-4" />
            戻る
          </Link>
        </Button>
        <div>
          <h1 className="text-2xl font-bold tracking-tight">運営管理者の編集</h1>
          <p className="text-muted-foreground">運営管理者の情報を編集します</p>
        </div>
      </div>

      <div className="rounded-lg border bg-white">
        <div className="p-12 text-center">
          <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-primary mx-auto"></div>
          <p className="mt-3 text-sm text-muted-foreground">読み込み中...</p>
        </div>
      </div>
    </div>
  );
}
```

## API仕様

### エンドポイント

| エンドポイント        | メソッド | 説明           |
| --------------------- | -------- | -------------- |
| `/api/v1/admins/[id]` | GET      | 運営者詳細取得 |
| `/api/v1/admins/[id]` | PUT      | 運営者情報更新 |

### リクエスト仕様

#### 運営者詳細取得

- **パラメータ**: URL パラメータで運営者ID指定
- **レスポンス**: Admin型のデータオブジェクト

#### 運営者情報更新

```typescript
interface UpdateAdminRequest {
  name?: string;
  nameKana?: string;
  email?: string;
  phoneNumber?: string;
  department?: string;
}
```

### レスポンス仕様

```typescript
interface UpdateAdminResponse {
  id: string;
  name: string;
  nameKana: string;
  email: string;
  phoneNumber: string;
  department?: string;
  status: 'active' | 'inactive';
  lastLoginAt: string | null;
  createdAt: string;
  updatedAt: string;
}
```

## UI/UX仕様

### レスポンシブデザイン

- **デスクトップ**: 中央配置のフォームレイアウト
- **タブレット**: 1024px以下でも適切なフォーム表示
- **モバイル**: 768px以下でも適切な編集体験を提供

### アクセシビリティ

- **ラベル関連付け**: 全入力フィールドに適切なラベル設定
- **キーボードナビゲーション**: Tab キーでの順次移動対応
- **エラー通知**: スクリーンリーダー対応のエラーメッセージ
- **フォーカス管理**: 視覚的に明確なフォーカス表示

### インタラクション

#### 初期表示

- **データ読み込み**: 既存データでフィールドを事前入力
- **編集準備**: 即座に編集可能な状態で表示
- **変更追跡**: フィールド変更時の視覚的フィードバック

#### 編集体験

- **リアルタイムバリデーション**: 入力中の即座なフィードバック
- **変更表示**: 変更されたフィールドの視覚的ハイライト
- **保存状態**: 未保存の変更がある場合の警告表示

#### フィードバック

- **成功通知**: 更新成功時のトースト通知と自動遷移
- **エラー通知**: 更新失敗時のトースト通知
- **バリデーションエラー**: フィールド下部のインラインエラー表示

#### エラー状態表示

- **IDエラー**: 管理者IDが指定されていない場合の表示
- **データ取得エラー**: 運営者データ取得失敗時の表示
- **ネットワークエラー**: 通信エラー時の表示

### カラーテーマ

- **shadcn/ui**: デフォルトテーマを使用
- **変更ハイライト**: 変更されたフィールドの強調表示
- **エラー色**: 赤色系統でエラー状態を表示
- **成功色**: 緑色系統で成功状態を表示

## パフォーマンス最適化

### データ取得最適化

- **個別取得**: useAdmin フックによる効率的なデータ取得
- **キャッシュ活用**: 既存データの再利用
- **エラーリトライ**: 失敗時の適切なリトライ機能

### フォーム最適化

- **React Hook Form**: 効率的なフォーム状態管理
- **メモ化**: 不要な再レンダリングの防止
- **楽観的更新**: 更新成功時の即座のUI更新

### レンダリング最適化

- **条件付きレンダリング**: ローディング・エラー状態の効率的な表示切り替え
- **useEffect依存**: 適切な依存配列による不要な処理の防止

## セキュリティ仕様

### 認証・認可

- **運営者アクセス権限**: 編集対象運営者への適切なアクセス権限確認
- **URL直接アクセス**: 不正なIDでのアクセス時の適切なエラー処理
- **セッション管理**: 認証状態の適切な管理

### 入力検証

- **クライアント側バリデーション**: Zodスキーマによる厳密な入力検証
- **サーバー側バリデーション**: APIレベルでの二重チェック
- **XSS対策**: Reactの自動エスケープ機能
- **データ整合性**: 更新データの整合性チェック

### 操作制限

- **自己編集制限**: 必要に応じた自己編集の制限
- **権限チェック**: 適切な権限レベルでの操作制限
- **監査ログ**: 編集操作の記録

## 開発環境での動作

### モック機能

- **開発環境**: モックサービスによる更新処理シミュレーション
- **遅延シミュレーション**: 適切な遅延で実際のAPI通信を模擬
- **エラーテスト**: 意図的なエラー発生によるエラーハンドリングテスト

### テスト機能

- **データ取得テスト**: 正常系・異常系での運営者データ取得確認
- **フォーム初期化テスト**: 既存データでのフォーム初期化確認
- **更新処理テスト**: 各種入力パターンでの更新処理確認
- **バリデーションテスト**: 編集用バリデーションの動作確認
- **IDチェックテスト**: 無効なIDでのアクセス時の動作確認

## 参考資料

- [CareBase-admin プロジェクト](https://github.com/ambi-tious/CareBase-admin)
- [運営者一覧画面](../README.md)
- [運営者登録画面](../register/README.md)
- [運営者画面一覧](../../../../docs/運営者.md)
- [AdminForm コンポーネント](../../../../components/2_molecules/forms/admin-form.tsx)
- [useAdmins フック](../../../../hooks/use-admins.ts)
- [Admin 型定義](../../../../types/admin.ts)
- [Admin バリデーション](../../../../validations/admin-validation.ts)
- [React Hook Form ドキュメント](https://react-hook-form.com/)
- [Zod ドキュメント](https://zod.dev/)
- [shadcn/ui ドキュメント](https://ui.shadcn.com/)
