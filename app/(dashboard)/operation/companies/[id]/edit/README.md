# 会社編集画面設計書

- 画面名: `会社編集`
- パス: `/operation/companies/[id]/edit`
- URL: https://carebase-admin.vercel.app/operation/companies/[id]/edit

## 概要

運営者向け会社編集画面設計書です。
既存の会社情報を編集・更新する機能を提供し、基本情報、連絡先情報、代表者情報、その他情報の変更を行えます。

主要機能は以下の通りです：

1. 既存会社データの取得と表示
2. 多段階のフォーム編集（基本情報、連絡先、代表者、その他）
3. リアルタイムバリデーション機能
4. 入力データの検証とエラー表示
5. 更新処理とフィードバック表示
6. 会社詳細画面への遷移

## 全体レイアウト

### 画面構成

会社編集画面は、ページヘッダー、フォームセクション（4つのカード）、アクションボタンで構成されます。
既存データを事前に入力した状態で表示し、効率的な情報更新を支援します。

### 画面項目

| 項目名           | コンポーネント | 必須 | 最小桁数 | 最大桁数 | フォーマット | 初期値                     | 備考                                             |
| ---------------- | -------------- | ---- | -------- | -------- | ------------ | -------------------------- | ------------------------------------------------ |
| 戻るボタン       | Button + Link  | -    | -        | -        | -            | -                          | 会社詳細画面への戻るボタン                       |
| ページタイトル   | h1             | -    | -        | -        | -            | 会社編集                   | ページメインタイトル                             |
| ページ説明       | p              | -    | -        | -        | -            | {会社名}の情報を編集します | 編集対象会社名を含む説明文                       |
| 基本情報カード   | Card           | -    | -        | -        | -            | -                          | 会社の基本情報編集セクション                     |
| 連絡先情報カード | Card           | -    | -        | -        | -            | -                          | 連絡先情報編集セクション                         |
| 代表者情報カード | Card           | -    | -        | -        | -            | -                          | 代表者情報編集セクション                         |
| その他情報カード | Card           | -    | -        | -        | -            | -                          | その他の情報編集セクション                       |
| リセットボタン   | Button         | -    | -        | -        | -            | リセット                   | フォーム内容を初期値に戻す                       |
| 更新ボタン       | Button         | -    | -        | -        | -            | 更新する                   | 更新処理実行ボタン、ローディング状態表示機能付き |

## データ取得・表示仕様

### 初期データ読み込み

- **データ取得**: ページ読み込み時に会社IDから既存データを取得
- **フォーム初期化**: 取得したデータでフォームフィールドを初期化
- **ローディング表示**: データ取得中はローディングスピナーを表示
- **エラーハンドリング**: データ取得失敗時の適切なエラー表示

### 初期値設定

| 項目名         | 初期値設定                                    |
| -------------- | --------------------------------------------- |
| 会社名         | `company.name`                                |
| 会社名（カナ） | `company.nameKana`                            |
| 法人番号       | `company.corporateNumber` または空文字        |
| 事業種別       | `company.businessType`                        |
| 設立日         | `company.establishedDate` または空文字        |
| ステータス     | `company.status`                              |
| 住所           | `company.address`                             |
| 電話番号       | `company.phoneNumber`                         |
| メールアドレス | `company.email`                               |
| 代表者名       | `company.representativeName`                  |
| 役職           | `company.representativePosition` または空文字 |
| 資本金         | `company.capital` または空文字                |
| 従業員数       | `company.employeeCount` または 0              |
| 備考           | `company.notes` または空文字                  |

## フォーム構造

### 基本情報セクション

| 項目名         | コンポーネント | 必須 | 最小桁数 | 最大桁数 | フォーマット | プレースホルダー         | バリデーション                                 |
| -------------- | -------------- | ---- | -------- | -------- | ------------ | ------------------------ | ---------------------------------------------- |
| 会社名         | Input          | ◯    | 1        | 100      | text         | 株式会社サンプル         | 必須チェック、文字数チェック                   |
| 会社名（カナ） | Input          | ◯    | 1        | 100      | text         | カブシキガイシャサンプル | 必須チェック、カタカナチェック、文字数チェック |
| 法人番号       | Input          | -    | 13       | 13       | text         | 1234567890123            | 13桁数字チェック（任意）                       |
| 事業種別       | Select         | ◯    | -        | -        | select       | -                        | 必須チェック                                   |
| 設立日         | Input          | -    | -        | -        | date         | -                        | 日付フォーマットチェック（任意）               |
| ステータス     | Select         | -    | -        | -        | select       | 有効                     | デフォルト値設定                               |
| 住所           | Input          | ◯    | 1        | 200      | text         | 東京都渋谷区...          | 必須チェック、文字数チェック                   |

### 連絡先情報セクション

| 項目名         | コンポーネント | 必須 | 最小桁数 | 最大桁数 | フォーマット | プレースホルダー | バリデーション                             |
| -------------- | -------------- | ---- | -------- | -------- | ------------ | ---------------- | ------------------------------------------ |
| 電話番号       | Input          | ◯    | 1        | -        | text         | 03-1234-5678     | 必須チェック、電話番号フォーマットチェック |
| メールアドレス | Input          | ◯    | 1        | -        | email        | info@example.com | 必須チェック、メールフォーマットチェック   |

### 代表者情報セクション

| 項目名   | コンポーネント | 必須 | 最小桁数 | 最大桁数 | フォーマット | プレースホルダー | バリデーション               |
| -------- | -------------- | ---- | -------- | -------- | ------------ | ---------------- | ---------------------------- |
| 代表者名 | Input          | ◯    | 1        | 50       | text         | 山田太郎         | 必須チェック、文字数チェック |
| 役職     | Input          | -    | -        | 50       | text         | 代表取締役       | 文字数チェック（任意）       |

### その他情報セクション

| 項目名   | コンポーネント | 必須 | 最小桁数 | 最大桁数 | フォーマット | プレースホルダー                     | バリデーション              |
| -------- | -------------- | ---- | -------- | -------- | ------------ | ------------------------------------ | --------------------------- |
| 資本金   | Input          | -    | -        | 50       | text         | 1000万円                             | 文字数チェック（任意）      |
| 従業員数 | Input          | -    | 1        | -        | number       | 100                                  | 1以上の数値チェック（任意） |
| 備考     | Textarea       | -    | -        | 1000     | text         | その他の情報があれば入力してください | 文字数チェック（任意）      |

## 機能仕様

### アクション

| 項目名         | 処理内容                   | 対象API                      | 遷移先画面                                 |
| -------------- | -------------------------- | ---------------------------- | ------------------------------------------ |
| 戻るボタン     | 会社詳細画面へ戻る         | -                            | 会社詳細画面 (`/operation/companies/[id]`) |
| リセットボタン | フォーム内容を初期値に戻す | -                            | -                                          |
| 更新ボタン     | 会社更新処理を実行         | `PUT /api/v1/companies/[id]` | 会社詳細画面 (`/operation/companies/[id]`) |

### データフロー

#### 初期化フロー

1. **ページアクセス**: URLパラメータから会社IDを取得
2. **データ取得**: useCompany フックで会社データを取得
3. **ローディング表示**: データ取得中はスピナー表示
4. **フォーム初期化**: 取得データでフォームを初期化
5. **編集可能状態**: フォーム表示完了

#### 更新フロー

1. **バリデーション**: フォーム送信時にクライアント側バリデーション実行
2. **API呼び出し**: updateCompany関数で更新APIを呼び出し
3. **楽観的更新**: 成功時にローカル状態を即座に更新
4. **成功通知**: トースト通知で更新成功をフィードバック
5. **画面遷移**: 会社詳細画面に自動遷移

### 状態管理

#### データ取得状態

- **loading**: データ取得中の状態
- **error**: データ取得エラー時の状態
- **company**: 取得した会社データ
- **refetch**: データ再取得関数

#### フォーム状態

- **React Hook Form**: useFormフックによる効率的なフォーム状態管理
- **初期値設定**: useEffectで既存データをフォームに設定
- **リセット機能**: form.reset()で初期値に復元
- **変更検知**: フォームの変更状態を追跡

#### 処理状態

- **formLoading**: 更新処理中のローディング状態
- **ボタン無効化**: 処理中は全ボタンを無効化
- **エラーハンドリング**: 更新失敗時のエラー表示

### バリデーション仕様

#### 編集モード専用バリデーション

- **editCompanySchema**: 編集用のZodスキーマを使用
- **必須項目維持**: 登録時と同様の必須項目チェック
- **データ整合性**: 既存データとの整合性チェック
- **変更検知**: 実際に変更された項目のみを更新

## コンポーネント構成

### 主要コンポーネント

- **EditCompanyPage** (`app/(dashboard)/operation/companies/[id]/edit/page.tsx`)
  - ページ全体の制御とレイアウト
  - 会社データの取得と状態管理
  - フォーム送信処理とエラーハンドリング
  - 成功時の画面遷移制御

- **CompanyForm** (`components/2_molecules/forms/company-form.tsx`)
  - フォーム全体の制御とレイアウト
  - mode="edit"で編集モードに設定
  - initialData で既存データを初期値として設定
  - editCompanySchema による編集用バリデーション

### 状態管理フック

- **useCompany** (`hooks/use-companies.ts`)
  - 個別会社データの取得と管理
  - ローディング・エラー状態の管理
  - データ再取得機能

- **useCompanies** (`hooks/use-companies.ts`)
  - updateCompany関数による会社更新処理
  - 楽観的更新による UI 応答性向上
  - エラーハンドリングと状態管理

### ローディング・エラー状態

#### ローディング状態

```typescript
if (loading) {
  return (
    <div className="flex items-center justify-center h-64">
      <div className="text-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
        <p className="text-muted-foreground">読み込み中...</p>
      </div>
    </div>
  );
}
```

#### エラー状態

```typescript
if (error || !company) {
  return (
    <div className="flex items-center justify-center h-64">
      <div className="text-center space-y-4">
        <div className="text-red-600 text-lg font-medium">エラーが発生しました</div>
        <p className="text-muted-foreground">{error || '会社情報を取得できませんでした'}</p>
        <Button asChild>
          <Link href="/operation/companies">会社一覧に戻る</Link>
        </Button>
      </div>
    </div>
  );
}
```

## API仕様

### エンドポイント

| エンドポイント           | メソッド | 説明         |
| ------------------------ | -------- | ------------ |
| `/api/v1/companies/[id]` | GET      | 会社詳細取得 |
| `/api/v1/companies/[id]` | PUT      | 会社情報更新 |

### リクエスト仕様

#### 会社詳細取得

- **パラメータ**: URL パラメータで会社ID指定
- **レスポンス**: Company型のデータオブジェクト

#### 会社情報更新

```typescript
interface UpdateCompanyRequest {
  name?: string;
  nameKana?: string;
  corporateNumber?: string;
  address?: string;
  phoneNumber?: string;
  email?: string;
  representativeName?: string;
  representativePosition?: string;
  businessType?: string;
  establishedDate?: string;
  capital?: string;
  employeeCount?: number;
  status?: 'active' | 'inactive' | 'suspended';
  notes?: string;
}
```

### レスポンス仕様

```typescript
interface UpdateCompanyResponse {
  id: string;
  name: string;
  nameKana: string;
  corporateNumber?: string;
  address: string;
  phoneNumber: string;
  email: string;
  representativeName: string;
  representativePosition?: string;
  businessType: string;
  establishedDate?: string;
  capital?: string;
  employeeCount?: number;
  status: 'active' | 'inactive' | 'suspended';
  notes?: string;
  createdAt: string;
  updatedAt: string;
}
```

## UI/UX仕様

### レスポンシブデザイン

- **デスクトップ**: 2列グリッドレイアウトでフィールドを効率的に配置
- **タブレット**: 1024px以下では1列レイアウトに変更
- **モバイル**: 768px以下でも適切な編集体験を提供

### アクセシビリティ

- **ラベル関連付け**: 全入力フィールドに適切なラベル設定
- **キーボードナビゲーション**: Tab キーでの順次移動対応
- **エラー通知**: スクリーンリーダー対応のエラーメッセージ
- **フォーカス管理**: 視覚的に明確なフォーカス表示

### インタラクション

#### 初期表示

- **データ読み込み**: 既存データでフィールドを事前入力
- **編集準備**: 即座に編集可能な状態で表示
- **変更追跡**: フィールド変更時の視覚的フィードバック

#### 編集体験

- **リアルタイムバリデーション**: 入力中の即座なフィードバック
- **変更表示**: 変更されたフィールドの視覚的ハイライト
- **保存状態**: 未保存の変更がある場合の警告表示

#### フィードバック

- **成功通知**: 更新成功時のトースト通知と自動遷移
- **エラー通知**: 更新失敗時のトースト通知
- **バリデーションエラー**: フィールド下部のインラインエラー表示

### カラーテーマ

- **shadcn/ui**: デフォルトテーマを使用
- **変更ハイライト**: 変更されたフィールドの強調表示
- **エラー色**: 赤色系統でエラー状態を表示
- **成功色**: 緑色系統で成功状態を表示

## パフォーマンス最適化

### データ取得最適化

- **個別取得**: useCompany フックによる効率的なデータ取得
- **キャッシュ活用**: 既存データの再利用
- **エラーリトライ**: 失敗時の適切なリトライ機能

### フォーム最適化

- **React Hook Form**: 効率的なフォーム状態管理
- **メモ化**: 不要な再レンダリングの防止
- **楽観的更新**: 更新成功時の即座のUI更新

### レンダリング最適化

- **条件付きレンダリング**: ローディング・エラー状態の効率的な表示切り替え
- **useEffect依存**: 適切な依存配列による不要な処理の防止

## セキュリティ仕様

### 認証・認可

- **会社アクセス権限**: 編集対象会社への適切なアクセス権限確認
- **URL直接アクセス**: 不正なIDでのアクセス時の適切なエラー処理
- **セッション管理**: 認証状態の適切な管理

### 入力検証

- **クライアント側バリデーション**: Zodスキーマによる厳密な入力検証
- **サーバー側バリデーション**: APIレベルでの二重チェック
- **XSS対策**: Reactの自動エスケープ機能
- **データ整合性**: 更新データの整合性チェック

## 開発環境での動作

### モック機能

- **開発環境**: モックサービスによる更新処理シミュレーション
- **遅延シミュレーション**: 500msの遅延で実際のAPI通信を模擬
- **エラーテスト**: 意図的なエラー発生によるエラーハンドリングテスト

### テスト機能

- **データ取得テスト**: 正常系・異常系での会社データ取得確認
- **フォーム初期化テスト**: 既存データでのフォーム初期化確認
- **更新処理テスト**: 各種入力パターンでの更新処理確認
- **バリデーションテスト**: 編集用バリデーションの動作確認

## 参考資料

- [CareBase-admin プロジェクト](https://github.com/ambi-tious/CareBase-admin)
- [会社詳細画面](../README.md)
- [会社一覧画面](../../README.md)
- [会社登録画面](../../register/README.md)
- [運営者画面一覧](../../../../../docs/運営者.md)
- [CompanyForm コンポーネント](../../../../../components/2_molecules/forms/company-form.tsx)
- [useCompanies フック](../../../../../hooks/use-companies.ts)
- [Company バリデーション](../../../../../validations/company-validation.ts)
- [React Hook Form ドキュメント](https://react-hook-form.com/)
- [Zod ドキュメント](https://zod.dev/)
- [shadcn/ui ドキュメント](https://ui.shadcn.com/)
