# 事業所登録画面設計書

- 画面名: `事業所登録`
- パス: `/operation/offices/register`
- URL: https://carebase-admin.vercel.app/operation/offices/register

## 概要

運営者向け事業所登録画面設計書です。
新しい事業所と事業所管理者を同時に登録する機能を提供し、事業所の基本情報と管理者情報を一括で設定できます。

主要機能は以下の通りです：

1. 事業所情報の登録（基本情報、連絡先、営業時間等）
2. 事業所管理者情報の同時登録
3. 一時パスワード自動生成機能
4. 登録成功時のモーダル表示
5. 登録完了後の事業所一覧への遷移

## 全体レイアウト

### 画面構成

事業所登録画面は、ページヘッダー、複合フォーム（事業所情報＋管理者情報）、登録成功モーダルで構成されます。
効率的な事業所開設手続きを支援するため、必要な情報を一画面で完結できる設計を採用しています。

### 画面項目

| 項目名                 | コンポーネント                 | 必須 | 最小桁数 | 最大桁数 | フォーマット | 初期値                                       | 備考                         |
| ---------------------- | ------------------------------ | ---- | -------- | -------- | ------------ | -------------------------------------------- | ---------------------------- |
| 戻るボタン             | Button + Link                  | -    | -        | -        | -            | -                                            | 事業所一覧画面への戻るボタン |
| ページタイトル         | h1                             | -    | -        | -        | -            | 事業所登録                                   | ページメインタイトル         |
| ページ説明             | p                              | -    | -        | -        | -            | 新しい事業所と事業所管理者を同時に登録します | ページ説明文                 |
| 事業所・管理者フォーム | OfficeWithManagerForm          | -    | -        | -        | -            | -                                            | 事業所と管理者の複合フォーム |
| 登録成功モーダル       | OfficeRegistrationSuccessModal | -    | -        | -        | -            | -                                            | 登録成功時の確認モーダル     |
| ローディング表示       | LoadingSpinner                 | -    | -        | -        | -            | "読み込み中..."                              | 会社データ取得中の表示       |

## フォーム構造

### 事業所基本情報セクション

| 項目名       | コンポーネント | 必須 | 最小桁数 | 最大桁数 | フォーマット | プレースホルダー           | バリデーション                             |
| ------------ | -------------- | ---- | -------- | -------- | ------------ | -------------------------- | ------------------------------------------ |
| 事業所名     | Input          | ◯    | 1        | 100      | text         | さくら訪問看護ステーション | 必須チェック、文字数チェック               |
| 法人選択     | Select         | ◯    | -        | -        | select       | -                          | 必須チェック                               |
| 住所         | Input          | ◯    | 1        | 200      | text         | 東京都渋谷区...            | 必須チェック、文字数チェック               |
| 電話番号     | Input          | ◯    | 1        | -        | text         | 03-1234-5678               | 必須チェック、電話番号フォーマットチェック |
| サービス種別 | Select         | ◯    | -        | -        | select       | -                          | 必須チェック                               |
| 定員         | Input          | ◯    | 1        | -        | number       | 50                         | 必須チェック、1以上の数値チェック          |
| 開設日       | Input          | -    | -        | -        | date         | -                          | 日付フォーマットチェック（任意）           |
| 備考         | Textarea       | -    | -        | 1000     | text         | 事業所の詳細情報...        | 文字数チェック（任意）                     |

#### サービス種別選択肢

| 値               | 表示名             |
| ---------------- | ------------------ |
| visiting-nursing | 訪問看護           |
| day-service      | デイサービス       |
| home-help        | 訪問介護           |
| care-management  | 居宅介護支援       |
| group-home       | グループホーム     |
| rehabilitation   | リハビリテーション |

### 事業所管理者情報セクション

| 項目名           | コンポーネント | 必須 | 最小桁数 | 最大桁数 | フォーマット | プレースホルダー    | バリデーション                                 |
| ---------------- | -------------- | ---- | -------- | -------- | ------------ | ------------------- | ---------------------------------------------- |
| 管理者名         | Input          | ◯    | 1        | 50       | text         | 山田太郎            | 必須チェック、文字数チェック                   |
| 管理者名（カナ） | Input          | ◯    | 1        | 50       | text         | ヤマダタロウ        | 必須チェック、カタカナチェック、文字数チェック |
| メールアドレス   | Input          | ◯    | 1        | -        | email        | manager@example.com | 必須チェック、メールフォーマットチェック       |
| 電話番号         | Input          | ◯    | 1        | -        | text         | 090-1234-5678       | 必須チェック、電話番号フォーマットチェック     |

## 機能仕様

### アクション

| 項目名     | 処理内容                         | 対象API                             | 遷移先画面                            |
| ---------- | -------------------------------- | ----------------------------------- | ------------------------------------- |
| 戻るボタン | 事業所一覧画面へ戻る             | -                                   | 事業所一覧画面 (`/operation/offices`) |
| 登録ボタン | 事業所・管理者一括登録処理を実行 | `POST /api/v1/offices/with-manager` | -                                     |
| 一覧へ戻る | 事業所一覧画面へ遷移             | -                                   | 事業所一覧画面 (`/operation/offices`) |

### 登録処理フロー

#### 一括登録仕様

1. **データ検証**: フォーム入力データの包括的バリデーション
2. **API呼び出し**: 事業所と管理者の同時作成API実行
3. **パスワード生成**: 管理者用一時パスワードの自動生成
4. **成功モーダル**: 登録結果の表示（事業所情報、管理者情報、一時パスワード）
5. **画面遷移**: 事業所一覧への自動遷移

#### 一時パスワード生成

- **文字種**: 英数字（紛らわしい文字を除外）
- **文字数**: 12文字
- **除外文字**: I, l, O, 0, 1 等の識別困難文字
- **生成アルゴリズム**: セキュアランダム生成

### 状態管理

#### データ取得状態

- **companies**: 法人一覧データの取得
- **companiesLoading**: 法人データ取得中の状態
- **loading**: 登録処理中の状態

#### フォーム状態

- **OfficeWithManagerForm**: 複合フォームによる統合管理
- **バリデーション**: 事業所・管理者両方の入力検証
- **エラーハンドリング**: セクション別のエラー表示

#### モーダル状態

- **showSuccessModal**: 登録成功モーダルの表示状態
- **registrationData**: 登録結果データ（事業所情報、管理者情報、一時パスワード）

### バリデーション仕様

#### 事業所情報バリデーション

| 項目名       | バリデーション内容             |
| ------------ | ------------------------------ |
| 事業所名     | 必須、1-100文字                |
| 法人選択     | 必須、有効な法人IDの選択       |
| 住所         | 必須、1-200文字                |
| 電話番号     | 必須、電話番号フォーマット     |
| サービス種別 | 必須、有効なサービス種別の選択 |
| 定員         | 必須、1以上の数値              |
| 開設日       | 任意、有効な日付フォーマット   |
| 備考         | 任意、最大1000文字             |

#### 管理者情報バリデーション

| 項目名           | バリデーション内容                                 |
| ---------------- | -------------------------------------------------- |
| 管理者名         | 必須、1-50文字                                     |
| 管理者名（カナ） | 必須、1-50文字、カタカナのみ（`/^[ァ-ヶー\s]+$/`） |
| メールアドレス   | 必須、メールフォーマット                           |
| 電話番号         | 必須、電話番号フォーマット                         |

## コンポーネント構成

### 主要コンポーネント

- **RegisterOfficePage** (`app/(dashboard)/operation/offices/register/page.tsx`)
  - ページ全体の制御とレイアウト
  - 法人データの取得と管理
  - 登録処理とモーダル制御
  - 一時パスワード生成機能

- **OfficeWithManagerForm** (`components/2_molecules/forms/office-with-manager-form.tsx`)
  - 事業所・管理者複合フォームの実装
  - 統合バリデーション機能
  - セクション別レイアウト管理

- **OfficeRegistrationSuccessModal** (`components/2_molecules/modals/office-registration-success-modal.tsx`)
  - 登録成功時のモーダル表示
  - 登録結果の詳細表示
  - 一時パスワードの表示と注意事項

### UI コンポーネント

- **Button** (`components/ui/button.tsx`)
  - 戻るボタン、登録ボタンの実装
  - ローディング状態対応

- **Input, Select, Textarea** (`components/ui/`)
  - フォーム入力コンポーネント群
  - バリデーション表示対応

### カスタムフック

- **useCompanies** (`hooks/use-companies.ts`)
  - 法人データの取得と管理
  - 選択肢用データの提供

## API仕様

### エンドポイント

| エンドポイント                 | メソッド | 説明                     |
| ------------------------------ | -------- | ------------------------ |
| `/api/v1/offices/with-manager` | POST     | 事業所・管理者一括登録   |
| `/api/v1/companies`            | GET      | 法人一覧取得（選択肢用） |

### リクエスト仕様

#### 事業所・管理者一括登録

```typescript
interface OfficeWithManagerRegistration {
  office: {
    name: string;
    companyId: string;
    address: string;
    phoneNumber: string;
    serviceType: string;
    capacity: number;
    establishedDate?: string;
    description?: string;
  };
  manager: {
    name: string;
    nameKana: string;
    email: string;
    phoneNumber: string;
  };
}
```

### レスポンス仕様

#### 登録成功レスポンス

```typescript
interface OfficeRegistrationResponse {
  office: {
    id: string;
    name: string;
  };
  manager: {
    id: string;
    name: string;
    email: string;
    temporaryPassword: string;
  };
}
```

## UI/UX仕様

### レスポンシブデザイン

- **デスクトップ**: 2列レイアウトでフォームを効率的に配置
- **タブレット**: 1024px以下では1列レイアウトに変更
- **モバイル**: 768px以下でも適切な入力体験を提供

### アクセシビリティ

- **ラベル関連付け**: 全入力フィールドに適切なラベル設定
- **キーボードナビゲーション**: Tab キーでの順次移動対応
- **エラー通知**: スクリーンリーダー対応のエラーメッセージ
- **フォーカス管理**: 視覚的に明確なフォーカス表示

### インタラクション

#### フォーム体験

- **セクション分け**: 事業所情報と管理者情報の明確な分離
- **プログレッシブ開示**: 必要な情報を段階的に表示
- **リアルタイムバリデーション**: 入力中の即座なフィードバック

#### 登録成功体験

- **成功モーダル**: 登録完了の明確な通知
- **重要情報表示**: 一時パスワード等の重要情報を強調表示
- **次のアクション**: 明確な次のステップの提示

#### ローディング状態

- **初期読み込み**: 法人データ取得中のスピナー表示
- **登録処理中**: ボタンの無効化とローディング表示
- **処理時間表示**: 長時間処理の進捗表示

### カラーテーマ

- **shadcn/ui**: デフォルトテーマを使用
- **成功色**: 登録成功時の緑色系統
- **注意色**: 一時パスワード等の重要情報は黄色系統
- **一貫性**: プロジェクト全体のデザインシステムに準拠

## パフォーマンス最適化

### データ管理

- **効率的フェッチ**: 必要な法人データのみを取得
- **状態管理**: 効率的な状態更新とイミュータブル操作
- **メモ化**: 不要な再レンダリングの防止

### フォーム最適化

- **React Hook Form**: 効率的なフォーム状態管理
- **zodResolver**: 型安全なバリデーション
- **分割バリデーション**: セクション別の効率的検証

### ネットワーク最適化

- **楽観的更新**: 登録成功時の即座のUI更新
- **エラーリトライ**: 失敗時の適切なリトライ機能
- **タイムアウト処理**: 長時間処理に対する適切な処理

## セキュリティ仕様

### 入力検証

- **クライアント側バリデーション**: Zodスキーマによる厳密な入力検証
- **サーバー側バリデーション**: APIレベルでの二重チェック
- **XSS対策**: Reactの自動エスケープ機能

### パスワード管理

- **一時パスワード**: セキュアな一時パスワード生成
- **パスワード表示**: 安全な一時表示と注意喚起
- **初回ログイン**: パスワード変更の強制

### データ保護

- **HTTPS通信**: 暗号化通信の強制
- **機密情報保護**: 適切なデータハンドリング
- **監査ログ**: 登録操作の記録

## 開発環境での動作

### モック機能

- **開発環境**: モック登録処理による動作シミュレーション
- **遅延シミュレーション**: 2秒の遅延で実際のAPI通信を模擬
- **一時パスワード**: ランダム生成による実際の動作確認

### テスト機能

- **フォームテスト**: 各種入力パターンでのバリデーション確認
- **登録処理テスト**: 正常系・異常系での動作確認
- **モーダルテスト**: 成功モーダルの表示・操作確認
- **レスポンシブテスト**: 各種画面サイズでの表示確認

## 参考資料

- [CareBase-admin プロジェクト](https://github.com/ambi-tious/CareBase-admin)
- [事業所一覧画面](../README.md)
- [運営者画面一覧](../../../../docs/運営者.md)
- [OfficeWithManagerForm コンポーネント](../../../../components/2_molecules/forms/office-with-manager-form.tsx)
- [OfficeRegistrationSuccessModal コンポーネント](../../../../components/2_molecules/modals/office-registration-success-modal.tsx)
- [useCompanies フック](../../../../hooks/use-companies.ts)
- [Office 型定義](../../../../types/office.ts)
- [FacilityManager 型定義](../../../../types/facility-manager.ts)
- [React Hook Form ドキュメント](https://react-hook-form.com/)
- [shadcn/ui ドキュメント](https://ui.shadcn.com/)
