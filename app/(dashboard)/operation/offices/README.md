# 事業所一覧画面設計書

- 画面名: `事業所一覧`
- パス: `/operation/offices`
- URL: https://carebase-admin.vercel.app/operation/offices

## 概要

運営者向け事業所一覧画面設計書です。
登録されている事業所の一覧表示、検索・フィルタリング機能、および各種操作（詳細表示、編集、削除）機能を提供します。

主要機能は以下の通りです：

1. 事業所一覧の表示（テーブル形式）
2. リアルタイム検索機能（事業所名、法人名、住所）
3. ソート機能（事業所名、法人名、利用状況、登録日）
4. 各事業所への操作（詳細表示、編集、削除）
5. 新規事業所登録への遷移
6. 利用状況の視覚的表示

## 全体レイアウト

### 画面構成

事業所一覧画面は、検索エリア、アクションボタンエリア、結果表示エリア、事業所テーブルで構成されます。
効率的な事業所管理を支援するため、直感的で使いやすいデザインを採用しています。

### 画面項目

| 項目名             | コンポーネント | 必須 | 最小桁数 | 最大桁数 | フォーマット | 初期値                         | 備考                                                  |
| ------------------ | -------------- | ---- | -------- | -------- | ------------ | ------------------------------ | ----------------------------------------------------- |
| 検索ボックス       | Input          | -    | -        | -        | text         | -                              | プレースホルダー：「事業所名、法人名、住所で検索...」 |
| 事業所を登録ボタン | Button + Link  | -    | -        | -        | -            | 事業所を登録                   | 新規登録画面への遷移ボタン                            |
| 結果件数表示       | テキスト       | -    | -        | -        | -            | "X 件の事業所が見つかりました" | 動的に件数を表示                                      |
| 事業所テーブル     | Table          | -    | -        | -        | -            | -                              | ソート機能付きテーブル                                |
| ローディング表示   | LoadingSpinner | -    | -        | -        | -            | "読み込み中..."                | データ取得中の表示                                    |
| 空状態表示         | EmptyState     | -    | -        | -        | -            | "事業所が見つかりません"       | データが0件の場合の表示                               |
| 削除確認ダイアログ | AlertDialog    | -    | -        | -        | -            | "事業所を削除しますか？"       | 削除実行前の確認ダイアログ                            |

## テーブル構造

### テーブル列定義

| 列名        | 表示名       | 幅    | ソート | 内容                                           |
| ----------- | ------------ | ----- | ------ | ---------------------------------------------- |
| office      | 事業所名     | 280px | ◯      | 事業所名（リンク）、住所、電話番号             |
| company     | 法人名       | 200px | ◯      | 法人名、管理者名                               |
| serviceType | サービス種別 | 120px | -      | サービス種別バッジ                             |
| status      | ステータス   | 100px | -      | 稼働状況（稼働中/停止中/一時停止）             |
| capacity    | 利用状況     | 140px | ◯      | 利用者数/定員、利用率インジケーター            |
| createdAt   | 登録日       | 100px | ◯      | 登録日時（YYYY/MM/DD形式）                     |
| actions     | 操作         | 60px  | -      | ドロップダウンメニュー（詳細表示、編集、削除） |

### 事業所情報列の詳細表示

- **事業所名**: クリック可能なリンク（詳細画面へ遷移）
- **住所**: MapPinアイコン付きで表示
- **電話番号**: Phoneアイコン付きで表示（存在する場合のみ）

### サービス種別表示

| サービス種別値   | 表示名             | バッジカラー |
| ---------------- | ------------------ | ------------ |
| visiting-nursing | 訪問看護           | 青色系       |
| day-service      | デイサービス       | 緑色系       |
| home-help        | 訪問介護           | 橙色系       |
| care-management  | 居宅介護支援       | 紫色系       |
| group-home       | グループホーム     | 赤色系       |
| rehabilitation   | リハビリテーション | 黄色系       |

### ステータス表示

| ステータス | 表示名   | バッジカラー                         |
| ---------- | -------- | ------------------------------------ |
| active     | 稼働中   | 緑色 (bg-green-100 text-green-800)   |
| inactive   | 停止中   | 灰色 (bg-gray-100 text-gray-800)     |
| suspended  | 一時停止 | 黄色 (bg-yellow-100 text-yellow-800) |

### 利用状況表示

- **利用者数/定員**: "30/50" 形式で表示
- **利用率**: プログレスバーで視覚的に表示
- **利用率計算**: (利用者数 / 定員) × 100
- **色分け**:
  - 80%以上: 赤色（満員に近い）
  - 60-79%: 黄色（やや多い）
  - 60%未満: 緑色（余裕あり）

## 機能仕様

### アクション

| 項目名             | 処理内容               | 対象API                       | 遷移先画面                                      |
| ------------------ | ---------------------- | ----------------------------- | ----------------------------------------------- |
| 検索ボックス入力   | リアルタイム検索実行   | `/api/v1/offices`             | -                                               |
| 事業所を登録ボタン | 新規登録画面へ遷移     | -                             | 事業所登録画面 (`/operation/offices/register`)  |
| 事業所名リンク     | 事業所詳細画面へ遷移   | -                             | 事業所詳細画面 (`/operation/offices/[id]`)      |
| テーブルヘッダー   | ソート実行             | -                             | -                                               |
| 詳細を見るメニュー | 事業所詳細画面へ遷移   | -                             | 事業所詳細画面 (`/operation/offices/[id]`)      |
| 編集メニュー       | 事業所編集画面へ遷移   | -                             | 事業所編集画面 (`/operation/offices/[id]/edit`) |
| 削除メニュー       | 削除確認ダイアログ表示 | -                             | -                                               |
| 削除実行           | 事業所削除処理         | `DELETE /api/v1/offices/[id]` | -                                               |

### 検索機能

#### 検索対象フィールド

- 事業所名 (`name`)
- 法人名 (`companyName`)
- 住所 (`address`)

#### 検索仕様

- **リアルタイム検索**: 入力中に自動的に検索を実行
- **部分一致**: 入力された文字列を含む項目を検索
- **大文字小文字区別なし**: 英字の大文字小文字を区別せずに検索
- **クライアント側フィルタリング**: 取得済みデータから絞り込み
- **デバウンス**: 入力頻度に応じた最適化

### ソート機能

#### ソート対象列

| 列名     | ソートキー     | デフォルト |
| -------- | -------------- | ---------- |
| 事業所名 | `name`         | 昇順       |
| 法人名   | `companyName`  | -          |
| 利用状況 | `currentUsers` | -          |
| 登録日   | `createdAt`    | -          |

#### ソート仕様

- **双方向ソート**: 昇順 ↔ 降順の切り替え
- **視覚的フィードバック**: ソート方向をアイコンで表示
- **文字列ソート**: 大文字小文字を区別せずにソート
- **日付ソート**: ISO文字列を日付として比較
- **数値ソート**: 利用者数の数値比較

### 状態管理

#### データフェッチング

- **初期読み込み**: コンポーネントマウント時に全件取得
- **自動更新**: 削除後のデータ再取得
- **エラーハンドリング**: 取得失敗時の適切な表示
- **ローディング状態**: 取得中のスピナー表示

#### 削除処理

- **楽観的更新**: 削除成功時に即座にUI更新
- **確認ダイアログ**: 削除実行前の確認
- **トースト通知**: 削除成功時の通知表示
- **エラーハンドリング**: 削除失敗時の適切な通知

## コンポーネント構成

### 主要コンポーネント

- **OfficesPage** (`app/(dashboard)/operation/offices/page.tsx`)
  - ページ全体の制御とレイアウト
  - 検索状態の管理
  - useOffices、useOfficeActionsフックによるデータ管理

- **OfficeTable** (`components/3_organisms/tables/office-table.tsx`)
  - テーブル全体の制御
  - ソート機能の実装
  - ローディング・空状態の表示制御
  - 削除確認ダイアログの管理

- **OfficeTableRow** (`components/2_molecules/tables/office-table-row.tsx`)
  - 各行の表示制御
  - ドロップダウンメニューの実装
  - サービス種別、ステータス、利用状況の表示

### 専用UIコンポーネント

- **ServiceTypeBadge** (`components/1_atoms/badges/service-type-badge.tsx`)
  - サービス種別の表示用バッジ
  - 種別に応じたカラーコーディング

- **StatusBadge** (`components/1_atoms/badges/status-badge.tsx`)
  - ステータス表示用バッジ
  - 状態に応じたカラーコーディング

- **CapacityIndicator** (`components/1_atoms/indicators/capacity-indicator.tsx`)
  - 利用状況の視覚的表示
  - プログレスバーとテキストの組み合わせ

### UI コンポーネント

- **Input** (`components/ui/input.tsx`)
  - 検索ボックスの実装
  - アイコン付き入力フィールド

- **Button** (`components/ui/button.tsx`)
  - アクションボタンの実装
  - リンク機能付きボタン

- **Table関連** (`components/ui/table.tsx`)
  - Table, TableBody, TableHead, TableHeader, TableRow, TableCell
  - テーブル構造の基盤

- **AlertDialog関連** (`components/ui/alert-dialog.tsx`)
  - 削除確認ダイアログの実装

- **DropdownMenu関連** (`components/ui/dropdown-menu.tsx`)
  - 操作メニューの実装

### カスタムフック

- **useOffices** (`hooks/use-offices.ts`)
  - 事業所データの取得・管理
  - ローディング・エラー状態の管理
  - データ再取得機能

- **useOfficeActions** (`hooks/use-offices.ts`)
  - 事業所のCRUD操作
  - 削除、更新、作成処理
  - エクスポート機能

## API仕様

### エンドポイント

| エンドポイント           | メソッド | 説明                     |
| ------------------------ | -------- | ------------------------ |
| `/api/v1/offices`        | GET      | 事業所一覧取得           |
| `/api/v1/offices`        | POST     | 事業所新規作成           |
| `/api/v1/offices/[id]`   | GET      | 事業所詳細取得           |
| `/api/v1/offices/[id]`   | PUT      | 事業所情報更新           |
| `/api/v1/offices/[id]`   | DELETE   | 事業所削除               |
| `/api/v1/offices/stats`  | GET      | 事業所統計情報取得       |
| `/api/v1/offices/export` | GET      | 事業所データエクスポート |

### リクエスト仕様

#### 事業所一覧取得

```typescript
interface OfficeFilters {
  search?: string;
  serviceType?: string;
  status?: 'active' | 'inactive' | 'suspended';
  companyId?: string;
  city?: string;
  hasVacancy?: boolean;
}
```

#### レスポンス仕様

```typescript
interface Office {
  id: string;
  name: string;
  companyId: string;
  companyName: string;
  address: string;
  phoneNumber: string;
  faxNumber?: string;
  email?: string;
  website?: string;
  serviceType:
    | 'visiting-nursing'
    | 'day-service'
    | 'home-help'
    | 'care-management'
    | 'group-home'
    | 'rehabilitation';
  establishedDate?: string;
  capacity: number;
  currentUsers: number;
  staffCount: number;
  status: 'active' | 'inactive' | 'suspended';
  managerId?: string;
  managerName?: string;
  operatingHours: {
    [key: string]: {
      isOpen: boolean;
      openTime?: string;
      closeTime?: string;
    };
  };
  certifications: string[];
  createdAt: string;
  updatedAt: string;
}
```

## UI/UX仕様

### レスポンシブデザイン

- **デスクトップ**: フル機能のテーブル表示
- **タブレット**: 1024px以下でもテーブル構造を維持
- **モバイル**: 768px以下では適切なレイアウト調整

### アクセシビリティ

- **キーボードナビゲーション**: すべての操作がキーボードで実行可能
- **スクリーンリーダー対応**: 適切なARIA属性とalt属性
- **フォーカス管理**: 視覚的に明確なフォーカス表示
- **コントラスト比**: WCAG 2.1 AA準拠

### インタラクション

#### ホバー効果

- **テーブル行**: マウスオーバー時の背景色変更
- **ボタン**: ホバー時の色変更とトランジション
- **リンク**: ホバー時の色変更

#### ローディング状態

- **初期読み込み**: 中央配置のスピナーとメッセージ
- **削除中**: ボタンの無効化とローディング表示

#### 空状態

- **データなし**: 中央配置のアイコンとメッセージ
- **検索結果なし**: 検索条件変更を促すメッセージ
- **エラー状態**: 適切なエラーメッセージとリトライ機能

#### 視覚的フィードバック

- **利用状況インジケーター**: 利用率に応じた色分け表示
- **サービス種別バッジ**: 種別に応じたカラーコーディング
- **ステータスバッジ**: 状態に応じた色分け表示

### カラーテーマ

- **shadcn/ui**: デフォルトテーマを使用
- **サービス種別色**: 種別ごとの識別しやすい色分け
- **ステータス色**: 意味に応じた色分け（緑、灰、黄）
- **利用率色**: 利用状況に応じた色分け（緑、黄、赤）
- **危険操作**: 削除ボタンは destructive カラー使用

## パフォーマンス最適化

### データ管理

- **効率的フェッチ**: 必要なデータのみを取得
- **クライアント側フィルタリング**: 検索処理の高速化
- **状態管理**: 効率的な状態更新とイミュータブル操作

### レンダリング最適化

- **React.memo**: 不要な再レンダリングの防止
- **useCallback**: イベントハンドラーのメモ化
- **useMemo**: 計算処理のメモ化

### ネットワーク最適化

- **リクエスト最適化**: 不要なAPI呼び出しの削減
- **エラーリトライ**: 失敗時の適切なリトライ機能
- **キャッシュ戦略**: 適切なデータキャッシュ

## セキュリティ仕様

### 入力検証

- **XSS対策**: Reactの自動エスケープ機能
- **入力サニタイズ**: 検索クエリの適切な処理
- **SQLインジェクション対策**: パラメータ化クエリの使用

### 認証・認可

- **JWT認証**: トークンベース認証
- **権限チェック**: 運営者権限の確認
- **セッション管理**: 適切なセッション制御

### データ保護

- **HTTPS通信**: 暗号化通信の強制
- **機密情報**: 適切なデータマスキング
- **監査ログ**: 操作履歴の記録

## 開発環境での動作

### モックデータ

開発環境では以下のモック事業所データを使用：

- **サービス種別**: 訪問看護、デイサービス、訪問介護、居宅介護支援、グループホーム、リハビリテーション
- **ステータス**: 稼働中、停止中、一時停止
- **利用状況**: 定員と利用者数の組み合わせ
- **管理者情報**: 各事業所の管理者データ

### テスト機能

- **検索テスト**: 各種検索条件での動作確認
- **ソートテスト**: 各列でのソート動作確認
- **CRUD操作**: 作成・更新・削除操作の確認
- **エラーハンドリング**: エラー状態の表示確認
- **レスポンシブテスト**: 各種画面サイズでの表示確認

## 参考資料

- [CareBase-admin プロジェクト](https://github.com/ambi-tious/CareBase-admin)
- [運営者画面一覧](../../../docs/運営者.md)
- [画面一覧インデックス](../../../docs/screen-list.md)
- [OfficeTable コンポーネント](../../../components/3_organisms/tables/office-table.tsx)
- [useOffices フック](../../../hooks/use-offices.ts)
- [Office 型定義](../../../types/office.ts)
- [Office モックデータ](../../../mocks/offices.ts)
- [shadcn/ui ドキュメント](https://ui.shadcn.com/)
- [Lucide React アイコン](https://lucide.dev/)
