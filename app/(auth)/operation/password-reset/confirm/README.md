# パスワードリセット画面設計書

- 画面名: `運営者パスワード再設定`
- パス: `/operation/password-reset/confirm`
- URL: https://carebase-admin.vercel.app/operation/password-reset/confirm?token={reset_token}

## 概要

パスワードリマインダーで送られたメールのURLから遷移してパスワードリセット機能を提供する画面の設計書です。
有効期限内のリンクから新しいパスワードを設定し、成功時には自動ログインして運営管理TOPへ遷移する機能を実装します。

パスワードリセットフローは以下の通りです：

1. パスワードリマインダーメールのURLをクリック
2. 有効期限内の場合、パスワードリセット画面が表示
3. 新しいパスワードと確認用パスワードを入力
4. パスワード更新後、自動ログインして運営管理TOPに遷移
5. 認証情報はlocalStorageに永続化

## 全体レイアウト

### 画面構成

<img width="402" height="462" alt="image" src="https://github.com/user-attachments/assets/9c570c36-9321-4219-bc21-10ad7b86bca4" />

パスワードリセット画面は、CareBaseロゴ、パスワードリセットフォーム、フッターで構成されます。
ユーザーが安心して新しいパスワードを設定できるよう、シンプルで分かりやすいデザインを採用しています。

### 画面項目

| 項目名                   | コンポーネント  | 必須 | 最小桁数 | 最大桁数 | フォーマット | 初期値                               | 備考                                                       |
| ------------------------ | --------------- | ---- | -------- | -------- | ------------ | ------------------------------------ | ---------------------------------------------------------- |
| ページタイトル           | CardTitle       | -    | -        | -        | -            | 運営者パスワード再設定               | カード内ヘッダー                                           |
| ページ説明               | CardDescription | -    | -        | -        | -            | 新しいパスワードを入力してください。 | カード内説明文                                             |
| 新しいパスワード         | Input           | ◯    | 8        | -        | password     | -                                    | パスワード入力フィールド、リアルタイムバリデーション対応   |
| 新しいパスワード（確認） | Input           | ◯    | 8        | -        | password     | -                                    | 確認用パスワード入力フィールド、一致確認バリデーション対応 |
| エラーメッセージ         | テキスト        | -    | -        | -        | -            | -                                    | バリデーションエラー時に表示                               |
| リセットボタン           | Button          | -    | -        | -        | -            | パスワードをリセット                 | パスワード更新実行ボタン、ローディング状態表示機能付き     |
| 成功メッセージ           | テキスト        | -    | -        | -        | -            | パスワードが正常に更新されました。   | リセット成功時に表示                                       |
| ログインページリンク     | Button (Link)   | -    | -        | -        | -            | ログインページへ                     | 成功後のログインページへの遷移ボタン                       |

## 機能仕様

### アクション

| 項目名                   | 処理内容                           | 対象API                             | 遷移先画面                        |
| ------------------------ | ---------------------------------- | ----------------------------------- | --------------------------------- |
| パスワードリセット       | 新しいパスワードでリセットを実行   | `/api/v1/auth/admin/password-reset` | 成功メッセージ表示                |
| フォーム送信             | Enterキー押下時のリセット実行      | 同上                                | 同上                              |
| ログインページへ遷移     | パスワードリセット成功後の画面遷移 | -                                   | ログイン画面 (`/operation/login`) |
| 自動ログイン（将来実装） | リセット成功後の自動認証           | `/api/v1/auth/admin/login`          | 運営管理画面TOP (`/operation`)    |

### 入力チェック（リアルタイムバリデーション）

| 項目名                   | イベント   | チェック内容             | エラーメッセージ                             |
| ------------------------ | ---------- | ------------------------ | -------------------------------------------- |
| 新しいパスワード         | input/blur | 必須項目チェック         | パスワードは必須です                         |
| 新しいパスワード         | input/blur | 最小文字数チェック       | パスワードは8文字以上で設定してください      |
| 新しいパスワード（確認） | input/blur | 必須項目チェック         | 確認用パスワードは必須です                   |
| 新しいパスワード（確認） | input/blur | パスワード一致チェック   | パスワードが一致しません                     |
| フォーム全体             | submit     | 全フィールド入力チェック | 両方のパスワードフィールドを入力してください |
| フォーム全体             | submit     | トークン有効性チェック   | リンクが無効または期限切れです               |

### バリデーション仕様

#### リアルタイムバリデーション

- React Hookによる入力中のフィールドレベルバリデーション
- パスワード一致確認のリアルタイムチェック
- エラー状態の場合、フィールドを赤色でハイライト
- エラーメッセージをフィールド下部に表示
- 開発環境では緩和されたバリデーションを使用

#### フォームバリデーション

- 全フィールドが有効かつ入力済みの場合のみリセットボタンを有効化
- パスワード長（8文字以上）の強制
- パスワード一致確認の必須チェック
- 無効な状態では `disabled` 属性を設定

#### ローディング状態

- パスワードリセット処理中はローディングスピナーを表示
- ボタンテキストが「更新中...」に変更
- フォーム全体が無効化され、重複送信を防止

#### 成功状態

<img width="398" height="417" alt="image" src="https://github.com/user-attachments/assets/c07b872f-72be-4c61-8618-542e6a5ee076" />

- リセット成功時に成功メッセージとログインページへのリンクを表示

## URL認証とトークン仕様

### メールURL形式

```
https://carebase-admin.vercel.app/operation/password-reset/confirm?token={reset_token}
```

### トークン検証

- URLパラメータからリセットトークンを取得
- トークンの有効性と期限をサーバーサイドで検証
- 無効なトークンの場合はエラーメッセージを表示

### 有効期限チェック

- リセットトークンには24時間の有効期限を設定
- 期限切れの場合は再度パスワードリマインダーを送信するよう案内

## コンポーネント構成

### 主要コンポーネント

- **ResetPasswordForm** (`components/2_molecules/reset-password-form.tsx`)
  - フォーム全体の制御とレイアウト
  - useSearchParams でURLトークンを取得
  - shadcn/ui Cardコンポーネントを使用

- **Input** (`components/ui/input.tsx`)
  - shadcn/ui Input コンポーネント
  - type="password" でパスワード入力フィールド
  - required属性による基本バリデーション

- **Button** (`components/ui/button.tsx`)
  - shadcn/ui Button コンポーネント
  - type="submit" でフォーム送信
  - className="w-full" で全幅表示
  - ローディング状態とdisabled状態をサポート

- **Card関連** (`components/ui/card.tsx`)
  - Card, CardContent, CardDescription, CardTitle
  - パスワードリセットフォームのコンテナとして使用

- **Label** (`components/ui/label.tsx`)
  - shadcn/ui Label コンポーネント
  - フォームフィールドのラベル表示

### 状態管理

- **useState** フック
  - password, confirmPassword, error, isLoading, submitted の状態管理
  - リアルタイムな入力値の追跡とバリデーション状態

- **useSearchParams** フック
  - Next.js App Router による URLパラメータの取得
  - リセットトークンの抽出

## API仕様

### エンドポイント

| エンドポイント                         | 説明                       |
| -------------------------------------- | -------------------------- |
| `/api/v1/auth/admin/password-reset`    | パスワードリセット実行     |
| `/api/v1/auth/admin/password-reminder` | パスワードリマインダー送信 |
| `/api/v1/auth/admin/login`             | 自動ログイン（将来実装）   |

### パスワードリセットAPI

#### リクエスト仕様

```typescript
interface PasswordResetRequest {
  token: string; // URL パラメータから取得されるリセットトークン
  password: string; // 新しいパスワード
  confirmPassword: string; // 確認用パスワード
}
```

#### レスポンス仕様

```typescript
interface PasswordResetResponse {
  success: boolean;
  message?: string;
  error?: string;
}

// 成功時
{
  "success": true,
  "message": "パスワードが正常に更新されました。"
}

// エラー時
{
  "success": false,
  "error": "リンクが無効または期限切れです"
}
```

### トークン検証API

トークンの有効性は以下の条件で検証されます：

- トークンの存在確認
- トークンの形式検証
- 有効期限の確認（24時間以内）
- 使用済みトークンの重複利用防止

## UI/UX仕様

### レスポンシブデザイン

- **デスクトップ**: 最大幅 `max-w-md` (384px) のカード表示
- **タブレット**: 1024px以下でも同様のレイアウトを維持
- **モバイル**: 375px以下でも適切に表示

### アクセシビリティ

- 適切なラベル付け（Label コンポーネント使用）
- キーボードナビゲーション対応
- スクリーンリーダー対応
- 適切なコントラスト比の確保
- パスワードフィールドのアクセシビリティ向上

### カラーテーマ

- shadcn/ui のデフォルトテーマを使用
- エラー状態: `text-red-500` クラス
- 成功状態: `text-muted-foreground` クラス
- 一貫したデザインシステムの適用

### ユーザビリティ

- パスワード強度の視覚的フィードバック
- リアルタイムバリデーションによる即座なエラー表示
- 明確な成功/エラーメッセージ
- ローディング状態の分かりやすい表示

## セキュリティ仕様

### 入力検証

- パスワード最小文字数（8文字以上）の強制
- パスワード一致確認の必須チェック
- XSS対策（React の自動エスケープ）
- CSRF対策（トークンベース認証）

### トークンセキュリティ

- 一意なリセットトークンの生成
- トークンの有効期限管理（24時間）
- 使用済みトークンの無効化
- 暗号化されたトークンの使用

### 通信セキュリティ

- HTTPS通信の強制
- トークンの安全な送信
- セッション管理のセキュリティ

## 画面遷移仕様

### 正常フロー

1. **メールリンクアクセス** → パスワードリセット画面表示
2. **パスワード入力・送信** → 成功メッセージ表示
3. **ログインページへボタン** → ログイン画面遷移

### エラーフロー

1. **無効/期限切れトークン** → エラーメッセージ表示、パスワードリマインダーページへ案内
2. **バリデーションエラー** → エラーメッセージ表示、フォーム再入力
3. **API エラー** → エラーメッセージ表示、再試行案内

### 将来実装予定

- **自動ログイン機能**: パスワードリセット成功後に自動的にログインして運営管理TOPに遷移
- **パスワード強度チェック**: より厳密なパスワードポリシーの実装

## 開発環境での動作

### モック動作

開発環境では以下の動作でテストが可能です：

- 任意のトークンパラメータで画面アクセス可能
- パスワードリセット処理は1秒のモック処理を実行
- 成功メッセージ表示後、ログインページへの遷移が可能

### テストシナリオ

1. **正常系**: 有効なトークンでアクセス → パスワード入力 → 成功
2. **エラー系**: パスワード不一致 → エラーメッセージ表示
3. **エラー系**: 必須項目未入力 → バリデーションエラー表示

## 参考資料

- [パスワードリマインダー画面設計書](https://github.com/ambi-tious/CareBase-admin/issues/235)
- [ログイン画面設計書](../operation/login/README.md)
- [ResetPasswordForm コンポーネント](../../../components/2_molecules/reset-password-form.tsx)
- [パスワードリセット確認ページ](./confirm/page.tsx)
- [CareBase-staff設計書フォーマット](https://github.com/ambi-tious/CareBase-staff/issues/141)
- [shadcn/ui ドキュメント](https://ui.shadcn.com/)
