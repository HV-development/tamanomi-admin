# 静的ファイル取得方式の変更によるパストラバーサル攻撃対策

## 概要

`tamanomi-admin`の静的ファイル取得方式を、IDベースのAPI経由から`public`ディレクトリからの直接配信に変更し、パストラバーサル攻撃のリスクを解消しました。

## 変更前の問題点

### 脆弱性の内容

以前の実装では、`/_next/image`エンドポイントを使用して静的ファイルを取得していました。この方式では、以下のようなパストラバーサル攻撃が可能でした：

```
GET https://stg-admin.tamanomi.com/_next/image?url=../tamanomi_logo.svg&w=32&q=75
```

このリクエストにより、`public`ディレクトリ外のファイルにアクセスできる可能性がありました。

### 以前の実装

- `next.config.mjs`で画像最適化が有効（`unoptimized: true`が設定されていない）
- `/_next/image`エンドポイントを使用
- IDベースのAPI（`/api/static-files/[id]`）経由で静的ファイルを取得
- middlewareで静的ファイルへの直接アクセスをブロック

## 変更後の実装

### 対策内容

1. **`unoptimized: true`の設定**
   - `next.config.mjs`に`unoptimized: true`を追加
   - `/_next/image`エンドポイントを使用しない
   - `public`ディレクトリから直接配信

2. **静的ファイルの直接配信**
   - IDベースのAPIエンドポイントを削除
   - すべての`Image`コンポーネントを`public`ディレクトリからの直接パスに変更
   - 例：`/api/static-files/3` → `/tamanomi_logo.svg`

3. **middlewareの簡素化**
   - 静的ファイルへの直接アクセスブロック処理を削除
   - `/_next/image`エンドポイントの検証のみ残す（R2画像用）

## パストラバーサル攻撃のリスク解消理由

### 1. `/_next/image`エンドポイントを使用しない

`unoptimized: true`を設定することで、Next.jsの`Image`コンポーネントは`/_next/image`エンドポイントを使用せず、直接`public`ディレクトリからファイルを配信します。

**変更前（脆弱性あり）:**
```
Image src="/history.png" 
→ /_next/image?url=/history.png&w=24&q=75
→ パストラバーサル攻撃のリスクあり
```

**変更後（安全）:**
```
Image src="/history.png" 
→ /history.png（直接配信）
→ パストラバーサル攻撃のリスクなし
```

### 2. `public`ディレクトリからの直接配信

Next.jsの`public`ディレクトリからの直接配信は、Next.jsの標準機能であり、以下の理由で安全です：

- **ディレクトリ制限**: `public`ディレクトリ内のファイルのみが配信される
- **パス正規化**: Next.jsが自動的にパスを正規化し、`../`などの不正なパスを処理
- **ホワイトリスト方式**: `public`ディレクトリ内のファイルのみがアクセス可能

### 3. 攻撃パターンの無効化

以前の攻撃パターン：
```
GET /_next/image?url=../tamanomi_logo.svg&w=32&q=75
```

この攻撃は、`/_next/image`エンドポイントが存在し、URLパラメータでファイルパスを指定できる場合にのみ有効です。

変更後は：
- `/_next/image`エンドポイントを使用しない
- 直接パス（`/tamanomi_logo.svg`）でアクセス
- `../`などの不正なパスはNext.jsが自動的に処理

## セキュリティ上の利点

1. **シンプルな実装**: IDベースのAPIやマッピングファイルが不要
2. **Next.js標準機能の活用**: 実績のある安全な配信方式
3. **保守性の向上**: コードが簡潔になり、メンテナンスが容易
4. **統一性**: `tamanomi-web`と同じ方式で統一

## 検証方法

以下の方法で、パストラバーサル攻撃が無効化されたことを確認できます：

1. **直接パスでのアクセス**
   ```
   GET /tamanomi_logo.svg → 正常に配信される
   ```

2. **不正なパスの試行**
   ```
   GET /../tamanomi_logo.svg → Next.jsが自動的に処理（404または正規化）
   ```

3. **`/_next/image`エンドポイントの不使用**
   - 開発者ツールでネットワークリクエストを確認
   - `/_next/image`へのリクエストが発生しないことを確認

## まとめ

`unoptimized: true`を設定し、`public`ディレクトリからの直接配信に変更することで、`/_next/image`エンドポイントを使用しないため、パストラバーサル攻撃のリスクが解消されました。この方式は、Next.jsの標準機能を活用した安全でシンプルな実装です。

